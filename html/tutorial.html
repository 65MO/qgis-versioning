<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Tempus" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

        <title>Versioning</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">

          <h1 id="project_title">Versioning</h1>

          <a href="index.html">About</a> | <a href="authors.html">Authors</a> | <a href="documentation.html">Documentation</a> | <a href="tutorial.html">Tutorial</a> | <a href="screencast.html">Screencast</a> | <a href="installation.html">Installation</a>

            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">

<h3>Tutorial</h3>

<p>
The aim of this tutorial is to create a versioned database in posgresql/postgis following the gidelines in <a href=documentation.html>documentation</a> and to discover, through example, the versioning plugin for qgis. 
</p>

<h4>Database creation</h4>

<p>
This database consists of two tables: junctions and pipes. The columns are suitable to describe elements of an <a href=http://www.epa.gov/nrmrl/wswrd/dw/epanet.html>epanet model</a> (epanet is a simulation engine for drinking water distribution networks). The complete code for the database creation is available <a href=epanet_test_db.sql>here</a>.
</p>

<p>
First create a postgres database and enable spatial extensions. From a shell (or dos command) prompt, type:
</p>
<pre>
createdb epanet_test_db
psql epanet_test_db -c "CREATE EXTENSION postgis"
</pre>

<p>
Once this is done, we use a client to connect to the database. To use psql as a client, type in your shell/dos prompt:
<pre>
psql epanet_test_db
</pre>

<p>
First we create a schema that will store all our versioned tables. Copy the following sql commands in your posgresql client:
</p>
<pre>
CREATE SCHEMA epanet;
</pre>

We then create the two tables and add a couple of records.</p>
<pre>
CREATE TABLE epanet.junctions (
    fid serial PRIMARY KEY,
    id varchar,
    elevation float, 
    base_demand_flow float, 
    demand_pattern_id varchar, 
    geom geometry('POINT',2154)
);

INSERT INTO epanet.junctions
    (id, elevation, geom)
    VALUES
    ('0',0,ST_GeometryFromText('POINT(1 0)',2154));

INSERT INTO epanet.junctions
    (id, elevation, geom)
    VALUES
    ('1',1,ST_GeometryFromText('POINT(0 1)',2154));

CREATE TABLE epanet.pipes (
    fid serial PRIMARY KEY,
    id varchar,
    start_node varchar,
    end_node varchar,
    length float,
    diameter float,
    roughness float,
    minor_loss_coefficient float,
    status varchar,
    geom geometry('LINESTRING',2154) 
);

INSERT INTO epanet.pipes
    (id, start_node, end_node, length, diameter, geom) 
    VALUES
    ('0','0','1',1,2,ST_GeometryFromText('LINESTRING(1 0,0 1)',2154));
</pre>


<h4>Historization of the database</h4>

<p>
We start by creating table that will store information about revisions and add a record for our initial revision. We will call the branch 'trunk' as it is the custom in <a href=http://subversion.apache.org/svn>svn</a>. Within the posgresql client, issue the following commands:
</p>
<pre>
CREATE TABLE epanet.revisions(
    rev serial PRIMARY KEY,
    commit_msg varchar,
    branch varchar DEFAULT 'trunk',
    date timestamp DEFAULT current_timestamp,
    author varchar);

INSERT INTO epanet.revisions VALUES (1,'initial commit','trunk');
</pre>

<p>
Now we add the historization columns (note the trunk_ prefix on the column names):
</p>
<pre>
ALTER TABLE epanet.junctions
ADD COLUMN hid serial UNIQUE, 
ADD COLUMN trunk_rev_begin integer REFERENCES epanet.revisions(rev), 
ADD COLUMN trunk_rev_end integer REFERENCES epanet.revisions(rev), 
ADD COLUMN trunk_parent integer REFERENCES epanet.junctions(hid),
ADD COLUMN trunk_child  integer REFERENCES epanet.junctions(hid);

ALTER TABLE epanet.pipes
ADD COLUMN hid serial UNIQUE, 
ADD COLUMN trunk_rev_begin integer REFERENCES epanet.revisions(rev), 
ADD COLUMN trunk_rev_end integer REFERENCES epanet.revisions(rev), 
ADD COLUMN trunk_parent integer REFERENCES epanet.pipes(hid),
ADD COLUMN trunk_child  integer REFERENCES epanet.pipes(hid);
</pre>

<p>
We need to update the records in both table to set the initial revision:
</p>
<pre>
UPDATE epanet.junctions SET trunk_rev_begin = 1;

UPDATE epanet.pipes SET trunk_rev_begin = 1;
</pre>

<p>
Finally we create a schema that will store the views of tables in the current revision (or head revision).
</p>
<pre>
CREATE SCHEMA epanet_trunk_rev_head;
</pre>
<p>
and add the views that will always show the last revision:
</p>
<pre>
CREATE VIEW epanet_trunk_rev_head.junctions
AS SELECT hid, id, elevation, base_demand_flow, demand_pattern_id, geom
   FROM epanet.junctions
   WHERE trunk_rev_end IS NULL AND trunk_rev_begin IS NOT NULL;
  
CREATE VIEW epanet_trunk_rev_head.pipes
AS SELECT  hid, id, start_node, end_node, length, diameter, roughness, minor_loss_coefficient, status, geom 
   FROM epanet.pipes
   WHERE trunk_rev_end IS NULL AND trunk_rev_begin IS NOT NULL;
</pre>

<p>
We can test that everything is ok (in psql type 'Q' to end the display of a table):
</p>
<pre>
SELECT * FROM epanet_trunk_rev_head.junctions;
</pre>
<p>
and
</p>
<pre>
SELECT * FROM epanet_trunk_rev_head.pipes;
</pre>

<h4>Using the QGIS plugin</h4>

<p>
To install the QGIS plugin, follow the <a href=installation.html>installation instruction</a>. 
</p>

<p>
Open QGIS and make sure the plugin is enabled: in the 'Plugins' menu, there should be an entry 'versioning', if their is not, select 'Manage and Install Pluging...', type versioning in the 'Search' field and enable it.
</p>

<p>
Click on 'Add PostGIS Layer' and create a new connection named epanet_test_db to database epanet_test_db.
</p>

<p>
Add the layers junctions and pipes from the schema epanet_trunk_rev_head.
</p>

<p>
In menu Plugins&rarr;versioning&rarr;checkout. You will be prompted to select a file for your working copy (with extension .sqlite). Your versionned layers will be replaced by their equivalent in your working copy.
</p>

<p>
Now edit a layer and save your modifications.
</p>

<p>
When you are done editing, in menu Plugins&rarr;versioning&rarr;commit. You will be prompted enter a commit message. You should obtain an information message that your commit was successful. 
</p>


      </section>
    </div>

  </body>
</html>
